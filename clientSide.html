<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <style type="text/css">
<!--

.stateMachine {
  height : 0px;
  width  : 0px;
}

.shrmemo-main, .toPreviousDay, .toToday, .toNextDay, .targetDay,
.tuushintyuu, .tuushintyuuTitle, .tuushintyuuAnime,
.tuushinError, .tuushinErrorTitle, .tuushinErrorOK {
  position : absolute;
}

.toPreviousDay, .toToday, .toNextDay {
  top    : 10px;
  height : 20px;
}

.toPreviousDay {
  left : 10px;
}

.toToday {
  left : 155px;
}

.toNextDay {
  left : 300px;
}

.targetDay {
  top  : 35px;
  left : 30px;
  background-color : #4169e1;
  color : white;
}

.shrmemo-main {
  top  : 60px;
  left : 10px;
  width : 600px;
  height : 350px;
  background-color : #ffffe0;

}

.tuushintyuu{
  top  : 100px;
  left : 110px;
  width : 300px;
  height : 200px;
  background-color : #b0c4de;
  z-indez : 2;
}

.tuushintyuuTitle{
  top : 40px;
  left : 50px;
}

.tuushintyuuAnime {
  top : 80px;
  left : 50px;
  height : 30px;
  width  : 30px;
  background-color : white;
  animation : elm 2s infinite;
}

@keyframes elm {
  to {
    transform : translate(150px);
  }
}

.tuushinError{
  top  : 100px;
  left : 110px;
  width : 300px;
  height : 200px;
  background-color : #ff6347;
  z-indez : 2;
}

.tuushinErrorTitle{
  top  : 40px;
  left : 50px;
}

.tuushinErrorOK {
  top  : 160px;
  left : 130px;
  font-size: large;
}

-->
    </style>
  </head>
  <body>
    <div class="stateMachine"></div>
    <div class="toPreviousDay"><< 前の日へ</div>
    <div class="toToday"></div>
    <div class="toNextDay">次の日へ >></div>
    <div class="targetDay"></div>
    <div class="shrmemo-main">
    <div class="tuushintyuu">
      <div class="tuushintyuuTitle">通信しています</div>
      <div class="tuushintyuuAnime"></div>
    </div>
    <div class="tuushinError">
      <div class="tuushinErrorTitle">通信エラーが発生しました</div>
      <button class="tuushinErrorOK">OK</button>
    </div>

    <script>
      const logout = true,
        youbiStr = ['日','月','火','水','木','金','土'];

// ****** ローカルで動かすときのダミー。後で消す。******
/*
let google = {
  script : {
    run : {
      withSuccessHandler : 
        function (seikouFunc) {
          return {
            withFailureHandler : function (shippaiFunc) {
              return { 
                getNaiyouFromDB : function (arg){
                  console.log('getNaiyouFromDB dummy called');
                  setTimeout(function () {
                    let arg = {result:[ ['2023-4-7', '金', 'B', ''],
                                        ['2023-4-8', '土', '', 'hihi'],
                                        ['2023-4-9', '日', '', ''],
                                        ['2023-4-10', '月', 'A', 'あああ\nいいい'],
                                        ['2023-4-11', '火', 'A', 'いいい'] ] };
                    seikouFunc(arg);
                    //shippaiFunc();
                  }, 200)
                }
              }
            }
          }
        }
    }
  }
}
*/

/* モジュール内ユーティリティ *******************************************************/

      const enumEvent = {
        loadDone            : 'loadDone',           // htmlのロード完了
        receiveDone         : 'receiveDone',        // データ取得完了
        receiveError        : 'receiveError',       // データ取得エラー
        userPrevDay         : 'userPrevDay',        // ユーザ操作による前日へ
        userToday           : 'userToday',          // ユーザ操作による当日へ
        userNextDay         : 'userNextDay',        // ユーザ操作による翌日へ
        userOK              : 'userOK'              // OK
      }

      let stateMachine = (function () {
        const enumState = {
          none                : 'none',               // 初期状態のみ使用
          receiving           : 'receiving',          // データ受信中
          shrMemo             : 'shrMemo',            // SHRメモ表示中
          dialogError         : 'dialogError'         // エラーが発生した
        };

        let element, 
          state = enumState.none;      // 状態をこれで管理する

        // 状態遷移はここに集約して管理する
        function engine(e) {
          if (logout) {
            console.log('** engine event (state:' + state + ') **');
            console.log(e.type + ':' + e.detail.para1 + ':' + e.detail.para2);
          }

          switch(state) {
            case enumState.none:               // 初期状態のみ使用
              switch(e.type) {
                case enumEvent.loadDone:
                  getNaiyou();
                  state = enumState.receiving;

                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.receiving:     // データ受信中
              switch(e.type) {
                case enumEvent.receiveDone:
                  dialogOff('tuushintyuu'); // 通信中ダイアログを除去
                  setNaiyou();      // 取得した内容を画面に表示
                  setModal(false);  // 操作を受け付ける
                  state = enumState.shrMemo;
                  break;
                case enumEvent.receiveError:
                  dialogOff('tuushintyuu'); // 通信中ダイアログを除去
                  dialogOn('tuushinError'); // 通信中エラーダイアログを表示
                  state = enumState.dialogError;
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.shrMemo:          // SHRメモ表示中
              switch(e.type) {
                case enumEvent.userPrevDay:
                  targetDate.previous();
                  setDayTitle();
                  setNaiyou();      // 取得した内容を画面に表示
                  break;
                case enumEvent.userToday:
                  targetDate.reset();
                  setDayTitle();
                  setNaiyou();      // 取得した内容を画面に表示
                  break;
                case enumEvent.userNextDay:
                  targetDate.next();
                  setDayTitle();
                  setNaiyou();      // 取得した内容を画面に表示
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.dialogError:         // エラーが発生した
              switch(e.type) {
                case enumEvent.userOK:
                  dialogOff('tuushinError'); // 通信中エラーダイアログを除去
                  setModal(false);  // 操作を受け付ける
                  state = enumState.shrMemo;
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            default:
              if (logout) { console.log("state error"); }
              break;
          }
        }

        function initStateMachine () {
          element = document.getElementsByClassName('stateMachine');

          for (eventName in enumEvent) {
            element[0].addEventListener(eventName, engine);
          }
        }

        function dispatchInnerEvent(eventName, para1, para2) {
          let myEvent = new CustomEvent ( eventName, {
            detail: { para1 : para1,
                      para2 : para2 }
          });

          element[0].dispatchEvent(myEvent);
        }

        // ここが公開API(モジュール内に対してだけだが)
        return { initStateMachine   : initStateMachine,    // htmlのロード後に初期化
                 dispatchInnerEvent : dispatchInnerEvent}; // 内部イベント送信
      })();

      let targetDate = (function() {
        let now     = new Date(), //最初は現在時に設定
          year    = now.getFullYear(),
          month   = now.getMonth(),
          day     = now.getDate(),
          youbi   = now.getDay(),
          koma;

        function _previous() {
          let d = new Date(year, month, day);

          d.setDate(d.getDate() - 1); // 前日
          year    = d.getFullYear(),
          month   = d.getMonth(),
          day     = d.getDate(),
          youbi   = d.getDay();
        }

        function _next() {
          let d = new Date(year, month, day);

          d.setDate(d.getDate() + 1); // 翌日
          year    = d.getFullYear(),
          month   = d.getMonth(),
          day     = d.getDate(),
          youbi   = d.getDay();
        }

        function _reset() {
          let d = new Date();

          year    = d.getFullYear(),
          month   = d.getMonth(),
          day     = d.getDate(),
          youbi   = d.getDay();
        }

        function _get() {
          return { year  : year,
                   month : month + 1, // 月は0始まり
                   day   : day,
                   youbi : youbiStr[youbi]};
        }

        // ここが公開API
        return { previous : _previous, // 対象日を前日にする
                 next     : _next,     // 対象日を翌日にする
                 reset    : _reset,    // 対象日を当日にする
                 get      : _get };    // 対象日を取得する
      })();

      let shrMemoDate = (function() {
        let memoContents = null;

        function _set(contents) {
          memoContents = contents;
        }
        
        function _get() {
          // 日付 曜日 A週/B週 メモの内容　の配列
          return memoContents;
        }

        // ここが公開API
        return { set : _set,  // SHRMemoデータを設定する
                 get : _get}; // SHRMemoデータを取得する
      })();

/* ページ読み込み時の処理 *******************************************************/

      window.onload = function(){
        let element,
          d = targetDate.get();

        // 状態遷移マシンの初期化
        stateMachine.initStateMachine();

        // 現在の日にちの設定
        element = document.getElementsByClassName('toToday');
        element[0].textContent = String(d.month) + '/' + String(d.day) + '(' + d.youbi + ')へ';

        // 対象日の設定
        setDayTitle();

        // 通信中以外のダイアログは表示されないようにする。
        dialogOff('tuushinError');

        // ボタンクリックのハンドラ登録
        registerClick();

        // 通信中のダイアログ表示中なので、それ以外は操作を受け付けない
        setModal(true);

        stateMachine.dispatchInnerEvent(enumEvent.loadDone);
      }

/* 描画系 *******************************************************/

      function dialogOff(target) {
        let element = document.getElementsByClassName(target);
          element[0].style.display ="none";
      }

      function dialogOn(target) {
        let element = document.getElementsByClassName(target);
          element[0].style.display ="block";
      }

      function setDayTitle() {
        let element, 
          d = targetDate.get();

        element = document.getElementsByClassName('targetDay');
        element[0].textContent = String(d.month) + '/' + String(d.day) + '(' + d.youbi + ')の予定';
      }

      function setNaiyou() {
        let element, data, tempstr, replacedStr,
          d = targetDate.get(),
          dayStr = String(d.year) + '-' + String(d.month) + '-' + String(d.day),
          datas = shrMemoDate.get(),
          daySelectf = function (dayStr) {
            return function (target) {
              if ( target[0] == dayStr ) {
                return true;
              }
            }
          };

        data = datas.find(daySelectf(dayStr));
        if (data != null) {
          if (data[2] == 'A') {
            tempstr ='今日はA週\n' 
          } else if (data[2] == 'B') {
            tempstr ='今日はB週\n'
          } else {
            tempstr ='';
          }
          tempstr += data[3];
          replacedStr = tempstr.replace(/\n/g, '<br>'); //改行に変換
          element = document.getElementsByClassName('shrmemo-main');
          element[0].innerHTML  = replacedStr;
        }
      }

/* 通信系 *******************************************************/

      // 全部一気に取る
      function getNaiyou () {
        google.script.run.withSuccessHandler(function(arg){
          // 成功時の処理
          shrMemoDate.set(arg.result);
          if (logout) {
            console.log("getNaiyou success");
            console.log(arg.res);
          }
          stateMachine.dispatchInnerEvent(enumEvent.receiveDone);

        }).withFailureHandler(function(arg){
          // 失敗時の処理
          if (logout) {console.log("getNaiyou failure")};

          stateMachine.dispatchInnerEvent(enumEvent.receiveError);

        }).getNaiyouFromDB();
      }

/* イベントハンドラ系 *******************************************************/

      function onPreviousDayClick() {
        stateMachine.dispatchInnerEvent(enumEvent.userPrevDay);
      }

      function onNextDayClick() {
        stateMachine.dispatchInnerEvent(enumEvent.userNextDay);
      }

      function onTodayClick() {
        stateMachine.dispatchInnerEvent(enumEvent.userToday);
      }

      function ontuushinErrorOK() {
        stateMachine.dispatchInnerEvent(enumEvent.userOK);
      }

      function setModal(flg) {
        let element, setModalconfig;

        if ( flg == true ) {
          setModalconfig = 'none';
        } else {
          setModalconfig = 'auto';
        }

        element = document.getElementsByClassName('toPreviousDay');
        element[0].style.pointerEvents = setModalconfig;
        element = document.getElementsByClassName('toToday');
        element[0].style.pointerEvents = setModalconfig;
        element = document.getElementsByClassName('toNextDay');
        element[0].style.pointerEvents = setModalconfig;
      }

/* イベントハンドラ登録系 *******************************************************/

      function registerClick() {
        let i, element;

        element = document.getElementsByClassName('toPreviousDay');
        element[0].addEventListener('click', onPreviousDayClick);

        element = document.getElementsByClassName('toNextDay');
        element[0].addEventListener('click', onNextDayClick);

        element = document.getElementsByClassName('toToday');
        element[0].addEventListener('click', onTodayClick);

        element = document.getElementsByClassName('tuushinErrorOK');
        element[0].addEventListener('click', ontuushinErrorOK);
      }

    </script>
  </body>
</html>