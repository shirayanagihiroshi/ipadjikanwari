<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <style type="text/css">
<!--

.stateMachine {
  height : 0px;
  width  : 0px;
}

.jikanwari-main, .toPreviousDay, .toToday, .toNextDay,
.targetDay, .inputNaiyou, .inputTitle, .closer,
.kamokuTitle, .kamokuBox, .naiyouTitle, .naiyouBox,
.motimonoTitle, .motimonoBox, .naiyouTouroku, .naiyouSakujyo,
.tuushintyuu, .tuushintyuuTitle, .tuushintyuuAnime,
.tuushinError, .tuushinErrorTitle, .tuushinErrorOK,
.kakunin, .kakuninTitle, .kakuninOK, .kakuninCancel {
  position : absolute;
}

.toPreviousDay, .toToday, .toNextDay {
  top    : 10px;
  height : 20px;
}

.toPreviousDay {
  left : 10px;
}

.toToday {
  left : 155px;
}

.toNextDay {
  left : 300px;
}

.targetDay {
  top  : 35px;
  left : 30px;
  background-color : #4169e1;
  color : white;
}

.jikanwari-main {
  top  : 60px;
  left : 10px;
}

.kamoku-1, .kamoku-2, .kamoku-3, .kamoku-4, .kamoku-5, .kamoku-6, .kamoku-7,
.naiyou-1, .naiyou-2, .naiyou-3, .naiyou-4, .naiyou-5, .naiyou-6, .naiyou-7,
.motimo-1, .motimo-2, .motimo-3, .motimo-4, .motimo-5, .motimo-6, .motimo-7 {
  height: 40px;
}

.kamoku-1, .kamoku-2, .kamoku-3, .kamoku-4, .kamoku-5, .kamoku-6, .kamoku-7 {
  width       : 100px;
  text-align  : center;
  line-height : 40px;
}

.naiyou-1, .naiyou-2, .naiyou-3, .naiyou-4, .naiyou-5, .naiyou-6, .naiyou-7,
.motimo-1, .motimo-2, .motimo-3, .motimo-4, .motimo-5, .motimo-6, .motimo-7 {
  width  : 240px;
  line-height : 20px; /* フォントサイズと上下の余白合計値 */
}

table {
  border-collapse : collapse;
}

.inputNaiyou {
  top  : 70px;
  left : 100px;
  width : 400px;
  height : 320px;
  background-color : #b0c4de;
  z-indez : 2;
}

.closer {
  top  : 5px;
  left : 375px;
}

.inputTitle, .kamokuTitle, .kamokuBox, .naiyouTitle, .naiyouBox, .motimonoTitle, .motimonoBox {
  left : 10px;
}

.inputTitle {
  top : 10px;
}

.kamokuTitle{
  top : 45px;
}

.kamokuBox{
  top   : 65px;
  height: 20px;
  width : 120px;
  resize: none;
}

.naiyouTitle {
  top : 105px;
}

.naiyouBox, .motimonoBox {
  height: 40px;
  width : 240px;
  resize: none;
}

.naiyouBox {
  top :125px;
}

.motimonoTitle {
  top : 185px;
}

.motimonoBox {
  top :205px;
}

.naiyouTouroku, .naiyouSakujyo {
  top   : 270px;
  font-size: large;
}

.naiyouTouroku {
  left : 220px;
}

.naiyouSakujyo {
  left : 90px;
}

.tuushintyuu{
  top  : 100px;
  left : 110px;
  width : 300px;
  height : 200px;
  background-color : #b0c4de;
  z-indez : 2;
}

.tuushintyuuTitle{
  top : 40px;
  left : 50px;
}

.tuushintyuuAnime {
  top : 80px;
  left : 50px;
  height : 30px;
  width  : 30px;
  background-color : white;
  animation : elm 2s infinite;
}

@keyframes elm {
  to {
    transform : translate(150px);
  }
}

.tuushinError{
  top  : 100px;
  left : 110px;
  width : 300px;
  height : 200px;
  background-color : #ff6347;
  z-indez : 2;
}

.tuushinErrorTitle{
  top  : 40px;
  left : 50px;
}

.tuushinErrorOK {
  top  : 160px;
  left : 130px;
  font-size: large;
}

.kakunin {
  top  : 100px;
  left : 110px;
  width : 380px;
  height : 280px;
  background-color : #ff6347;
  z-indez : 3;
}

.kakuninTitle {
  top  : 40px;
  left : 50px;
}

.kakuninOK, .kakuninCancel {
  top   : 180px;
  font-size: large;
}

.kakuninOK {
  left : 220px;
}

.kakuninCancel {
  left : 60px;
}

-->
    </style>
  </head>
  <body>
    <div class="stateMachine"></div>
    <div class="toPreviousDay"><< 前の日へ</div>
    <div class="toToday"></div>
    <div class="toNextDay">次の日へ >></div>
    <div class="targetDay"></div>
    <table class="jikanwari-main" border=1>
      <tr>
        <td></td>
        <td>科目</td>
        <td>内容</td>
        <td>持ち物</td>
      </tr>
      <tr>
        <td> 1 </td>
        <td> <div class="kamoku-1"></div> </td>
        <td> <div class="naiyou-1"></div> </td>
        <td> <div class="motimo-1"></div> </td>
      </tr>
      <tr>
        <td> 2 </td>
        <td> <div class="kamoku-2"></div> </td>
        <td> <div class="naiyou-2"></div> </td>
        <td> <div class="motimo-2"></div> </td>
      </tr>
      <tr>
        <td> 3 </td>
        <td> <div class="kamoku-3"></div> </td>
        <td> <div class="naiyou-3"></div> </td>
        <td> <div class="motimo-3"></div> </td>
      </tr>
      <tr>
        <td> 4 </td>
        <td> <div class="kamoku-4"></div> </td>
        <td> <div class="naiyou-4"></div> </td>
        <td> <div class="motimo-4"></div> </td>
      </tr>
      <tr>
        <td> 5 </td>
        <td> <div class="kamoku-5"></div> </td>
        <td> <div class="naiyou-5"></div> </td>
        <td> <div class="motimo-5"></div> </td>
      </tr>
      <tr>
        <td> 6 </td>
        <td> <div class="kamoku-6"></div> </td>
        <td> <div class="naiyou-6"></div> </td>
        <td> <div class="motimo-6"></div> </td>
      </tr>
      <tr>
        <td> 7 </td>
        <td> <div class="kamoku-7"></div> </td>
        <td> <div class="naiyou-7"></div> </td>
        <td> <div class="motimo-7"></div> </td>
      </tr>
    </table>
    <div class="inputNaiyou">
      <div class="inputTitle"></div>
      <div class="closer">x</div>
      <div class="kamokuTitle">科目</div>
      <textarea class="kamokuBox"></textarea>
      <div class="naiyouTitle">内容</div>
      <textarea class="naiyouBox"></textarea>
      <div class="motimonoTitle">持ち物</div>
      <textarea class="motimonoBox"></textarea>
      <button class="naiyouTouroku">登録</button>
      <button class="naiyouSakujyo">削除</button>
    </div>
    <div class="tuushintyuu">
      <div class="tuushintyuuTitle">通信しています</div>
      <div class="tuushintyuuAnime"></div>
    </div>
    <div class="tuushinError">
      <div class="tuushinErrorTitle">通信エラーが発生しました</div>
      <button class="tuushinErrorOK">OK</button>
    </div>
    <div class="kakunin">
      <div class="kakuninTitle">削除してよいですか？</div>
      <button class="kakuninOK">OK</button>
      <button class="kakuninCancel">Cancel</button>
    </div>

    <script>
      const logout = true,
        tableClsName = ['kamoku-1', 'naiyou-1', 'motimo-1',
                        'kamoku-2', 'naiyou-2', 'motimo-2',
                        'kamoku-3', 'naiyou-3', 'motimo-3',
                        'kamoku-4', 'naiyou-4', 'motimo-4',
                        'kamoku-5', 'naiyou-5', 'motimo-5',
                        'kamoku-6', 'naiyou-6', 'motimo-6',
                        'kamoku-7', 'naiyou-7', 'motimo-7'],
        youbiStr = ['日','月','火','水','木','金','土'];

// ****** ローカルで動かすときのダミー。後で消す。******
/*
let google = {
  script : {
    run : {
      withSuccessHandler : 
        function (seikouFunc) {
          return {
            withFailureHandler : function (shippaiFunc) {
              return { 
                getCalendarFromDB : function (arg){
                  console.log('getCalendarFromDB dummy called');
                  setTimeout(function () {
                    let arg = {result:[ [2023, 1, 13, '金', 'A'],
                                        [2023, 1, 14, '土', 'D'] ] };
                    seikouFunc(arg);
                    //shippaiFunc();
                  }, 200)
                },
                getJikanwariFromDB : function (arg){
                  console.log('getJikanwariFromDB dummy called');
                  setTimeout(function () {
                    let arg = {result:[ ['A週','月曜','火曜','水曜','木曜','金曜','土曜'],
                                        [1,    '道徳','社会','国語','社会','社会','英語'],
                                        [2,    '体育','国語','体育','国表','体育','理科'],
                                        [3,    '国語','数学','総合','英語','数学','数学'],
                                        [4,    '理科','美術','英語','技術','国語','学活'],
                                        [5,    '音楽','総合','数学','国語','英語',''    ],
                                        [6,    '家庭','数学','理科','数学','音楽',''    ],
                                        [7,    ''    ,''    ,''    ,''    ,''    ,''    ] ] };
                    seikouFunc(arg);
                    //shippaiFunc();
                  }, 200)
                },
                getNaiyouFromDB : function (arg){
                  console.log('getNaiyouFromDB dummy called');
                  setTimeout(function () {
                    let arg = {res:[ [11, 1, '国語', '作文', '教科書', 'ユーザA', 1],
                                     [11, 2, '', '証明', '教科書', 'ユーザB', 1] ] };
                    seikouFunc(arg);
                    //shippaiFunc();
                  }, 200)
                },
                putNaiyouToDB : function (year, month, day, moma, kamoku, naiyou, motimono){
                  console.log('putNaiyouToDB dummy called');
                  console.log(year + ':' + month + ':' + day + ':' + moma + ':' + kamoku + ':' + naiyou + ':' + motimono);
                  setTimeout(function () {
                    seikouFunc();
                    //shippaiFunc();
                  }, 200)
                },
              }
            }
          }
        }
    }
  }
}
*/

/* モジュール内ユーティリティ *******************************************************/

      const enumEvent = {
        loadDone            : 'loadDone',           // htmlのロード完了
        sendReceiveDone     : 'sendReceiveDone',    // 通信完了
        sendReceiveError    : 'sendReceiveError',   // 通信エラー
        userOK              : 'userOK',             // ユーザ操作によるOK
        userCancel          : 'userCancel',         // ユーザ操作によるキャンセル
        userRegister        : 'userRegister',       // ユーザ操作による登録
        userDelete          : 'userDelete',         // ユーザ操作による削除
        userPrevDay         : 'userPrevDay',        // ユーザ操作による前日へ
        userToday           : 'userToday',          // ユーザ操作による当日へ
        userNextDay         : 'userNextDay',        // ユーザ操作による翌日へ
        userInputNaiyou     : 'userInputNaiyou'     // ユーザ操作による内容入力へ
      }

      let stateMachine = (function () {
        const enumState = {
          none                : 'none',               // 初期状態のみ使用
          sendAndReceive      : 'sendAndReceive',     // データ送受信中(実際は受信だけ)
          writing             : 'writing',            // データ書き込み中
          jikanwari           : 'jikanwari',          // 時間割表示中
          dialogInputJikawari : 'dialogInputJikawari',// 時間割入力ダイアログ 
          sakujyoKakunin      : 'sakujyoKakunin',     // 削除確認画面
          dialogError         : 'dialogError'         // エラーが発生した
        };

        let element, 
          state = enumState.none,      // 状態をこれで管理する
          // フラグを不用意に増やすと死ぬ。可能な限り増やさないこと
          firstTimeDataGet = 0; // 起動時のみ使用
                                // 0:未完了, 1:成功, 2:失敗

        // 状態遷移はここに集約して管理する
        function engine(e) {
          if (logout) {
            console.log('** engine event (state:' + state + ') **');
            console.log(e.type + ':' + e.detail.para1 + ':' + e.detail.para2);
          }

          switch(state) {
            case enumState.none:               // 初期状態のみ使用
              switch(e.type) {
                case enumEvent.loadDone:
                  // 既に起動時の最初のデータ取得が完了している場合は
                  // データ送受信中を経ずに時間割表示中へ遷移
                  // ここでは画面表示はしなくても自動的に行われている
                  if (firstTimeDataGet == 1) {
                    dialogOff('tuushintyuu');
                    setNaiyou();
                    setModal(false);
                    state = enumState.jikanwari;

                  } else if (firstTimeDataGet == 2) {

                    dialogOff('tuushintyuu');
                    dialogOn('tuushinError');
                    state = enumState.dialogError;

                  } else {
                    // 普段はたぶんここに流れる
                    // ここでは画面表示はしなくても自動的に行われている
                    state = enumState.sendAndReceive;
                  }
                  break;

                // calendar内部モジュールの初期化時にデータ取得は開始している
                case enumEvent.sendReceiveDone:
                  firstTimeDataGet = 1;
                  break;
                case enumEvent.sendReceiveError:
                  firstTimeDataGet = 2;
                  break;

                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.sendAndReceive:     // データ送受信中
              switch(e.type) {
                case enumEvent.sendReceiveDone:
                  dialogOff('tuushintyuu'); // 通信中ダイアログを除去
                  setNaiyou();      // 取得した時間割の内容を画面に表示
                  setModal(false);  // 操作を受け付ける
                  state = enumState.jikanwari;
                  break;
                case enumEvent.sendReceiveError:
                  dialogOff('tuushintyuu'); // 通信中ダイアログを除去
                  dialogOn('tuushinError'); // 通信中エラーダイアログを表示
                  state = enumState.dialogError;
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.writing:     // データ書き込み中
              switch(e.type) {
                case enumEvent.sendReceiveDone:
                  setDayAndGetNaiyou();
                  state = enumState.sendAndReceive;
                  break;
                case enumEvent.sendReceiveError:
                  dialogOff('tuushintyuu'); // 通信中ダイアログを除去
                  dialogOn('tuushinError'); // 通信中エラーダイアログを表示
                  state = enumState.dialogError;
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.jikanwari:          // 時間割表示中
              switch(e.type) {
                case enumEvent.userPrevDay:
                  setDayAndGetNaiyou('previousDay');
                  setDayTitle();
                  dialogOn('tuushintyuu');
                  setModal(true);
                  state = enumState.sendAndReceive;
                  break;
                case enumEvent.userToday:
                  setDayAndGetNaiyou('today');
                  setDayTitle();
                  dialogOn('tuushintyuu');
                  setModal(true);
                  state = enumState.sendAndReceive;
                  break;
                case enumEvent.userNextDay:
                  setDayAndGetNaiyou('NextDay');
                  setDayTitle();
                  dialogOn('tuushintyuu');
                  setModal(true);
                  state = enumState.sendAndReceive;
                  break;
                case enumEvent.userInputNaiyou:
                  setInputNaiyou(e.detail.para1);
                  targetDate.setKoma(e.detail.para1);
                  setModal(true);
                  state = enumState.dialogInputJikawari;
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.dialogInputJikawari:// 時間割入力ダイアログ
              switch(e.type) {
                case enumEvent.userRegister:
                  putNaiyou();
                  dialogOff('inputNaiyou');
                  dialogOn('tuushintyuu');
                  state = enumState.writing;
                  break;
                case enumEvent.userDelete:
                  dialogOn('kakunin');
                  state = enumState.sakujyoKakunin;
                  break;
                case enumEvent.userCancel:
                  dialogOff('inputNaiyou');
                  setModal(false);
                  state = enumState.jikanwari;
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            case enumState.sakujyoKakunin:// 削除確認画面
              switch(e.type) {
                case enumEvent.userOK:
                  dialogOff('kakunin');
                  putNaiyouSakujyo();
                  dialogOff('inputNaiyou');
                  dialogOn('tuushintyuu');
                  state = enumState.writing;
                  break;
                case enumEvent.userCancel:
                  dialogOff('kakunin');
                  state = enumState.dialogInputJikawari;
                  break;
              }
              break;

            case enumState.dialogError:         // エラーが発生した
              switch(e.type) {
                case enumEvent.userOK:
                  dialogOff('tuushinError'); // 通信中エラーダイアログを除去
                  setModal(false);  // 操作を受け付ける
                  state = enumState.jikanwari;
                  break;
                default:
                  if (logout) { console.log("state error"); }
                  break;
              }
              break;

            default:
              if (logout) { console.log("state error"); }
              break;
          }
        }

        function initStateMachine () {
          element = document.getElementsByClassName('stateMachine');

          for (eventName in enumEvent) {
            element[0].addEventListener(eventName, engine);
          }
        }

        function dispatchInnerEvent(eventName, para1, para2) {
          let myEvent = new CustomEvent ( eventName, {
            detail: { para1 : para1,
                      para2 : para2 }
          });

          element[0].dispatchEvent(myEvent);
        }

        // ここが公開API(モジュール内に対してだけだが)
        return { initStateMachine   : initStateMachine,    // htmlのロード後に初期化
                 dispatchInnerEvent : dispatchInnerEvent}; // 内部イベント送信
      })();

      let targetDate = (function() {
        let now     = new Date(), //最初は現在時に設定
          year    = now.getFullYear(),
          month   = now.getMonth(),
          day     = now.getDate(),
          youbi   = now.getDay(),
          koma;

        function _previous() {
          let d = new Date(year, month, day);

          d.setDate(d.getDate() - 1); // 前日
          year    = d.getFullYear(),
          month   = d.getMonth(),
          day     = d.getDate(),
          youbi   = d.getDay();
        }

        function _next() {
          let d = new Date(year, month, day);

          d.setDate(d.getDate() + 1); // 翌日
          year    = d.getFullYear(),
          month   = d.getMonth(),
          day     = d.getDate(),
          youbi   = d.getDay();
        }

        function _reset() {
          let d = new Date();

          year    = d.getFullYear(),
          month   = d.getMonth(),
          day     = d.getDate(),
          youbi   = d.getDay();
        }

        function _get() {
          return { year  : year,
                   month : month + 1, // 月は0始まり
                   day   : day,
                   youbi : youbiStr[youbi]};
        }

        function _setKoma(k) {
          koma = k;
        }

        function _getKoma() {
          return (koma);
        }

        // ここが公開API(モジュール内に対してだけだが)
        return { previous : _previous, // 対象日を前日にする
                 next     : _next,     // 対象日を翌日にする
                 reset    : _reset,    // 対象日を当日にする
                 get      : _get,      // 対象日を取得する
                 setKoma  : _setKoma,  // 対象のコマ(〇時間目)を保持。日と違いテーブルを
                 getKoma  : _getKoma };// クリックしたときに編集対象のコマが決まる
      })();

      let jikanwaritargetDate = (function() {
        let jikanwariContents = null;

        function _set(contents) {
          jikanwariContents = contents;
        }
        
        function _get() {
          return jikanwariContents;
        }

        // ここが公開API(モジュール内に対してだけだが)
        return { set : _set,  // 対象日の時間割データを設定する
                 get : _get}; // 対象日の時間割データを取得する
      })();

      let calendar = (function() {
        let cal = null,
          jikanwari = null;

        // DB(スプレッドシートで代用)へのアクセス頻度を減らすために
        // クライアント側で、カレンダー情報と時間割を保持しておく
        google.script.run.withSuccessHandler(function(arg){
          // 成功時の処理
          cal = arg.result;

          if (logout) {
            console.log("getCalendarFromDB success");
            console.log(cal);
          }

          google.script.run.withSuccessHandler(function(arg){
            let d = targetDate.get();

            // 成功時の処理
            jikanwari = arg.result;

            if (logout) {
              console.log("getJikanwariFromDB success");
              console.log(jikanwari);
            }

            // さらに、内容を取得する。
            setDayAndGetNaiyou()

          }).withFailureHandler(function(arg){
            // 失敗時の処理
            if (logout) {console.log("getJikanwariFromDB failure")};
            stateMachine.dispatchInnerEvent(enumEvent.sendReceiveError);

          }).getJikanwariFromDB();

        }).withFailureHandler(function(arg){
          // 失敗時の処理
          if (logout) {console.log("getCalendarFromDB failure")};
          stateMachine.dispatchInnerEvent(enumEvent.sendReceiveError);

        }).getCalendarFromDB();

        function _getSyuu (year, month, day) {
          let daySelectf = function (year, month, day) {
            return function (target) {
              if ( (target[0] == year) && (target[1] == month) && (target[2] == day)) {
                return true;
              }
            }
          };

          if (cal != null) {
            let d = cal.find(daySelectf(year, month, day));

            if (d != null) {
              return d[4]; // [年,月,日,曜日,A or B or ・・・]のはず
            }
            return 'err';
          }
        }

        function _getDefaultKamoku(syuu, youbi, koma) {
          if (jikanwari != null) {
            let _koma = koma,
              _youbi = youbi;

            if (syuu == 'A') {
              // do nothing
            } else if (syuu == 'B') {
              _koma = koma + 8;
            } else if (syuu == 'D') { //D:土曜
              _youbi = '土'; //強制的に曜日を変える
            } else { //Sもここ
              return '';
            }
            return (jikanwari[_koma][youbiStr.indexOf(_youbi)]);
          }
        }

        // ここが公開API(モジュール内に対してだけだが)
        return { getSyuu          : _getSyuu,          // 年月日からA週 or B週を取得
                 getDefaultKamoku : _getDefaultKamoku} // 時間割から科目を取得
      })();


/* ページ読み込み時の処理 *******************************************************/

      window.onload = function(){
        let element,
          d = targetDate.get();

        // 状態遷移マシンの初期化
        stateMachine.initStateMachine();

        // 現在の日にちの設定
        element = document.getElementsByClassName('toToday');
        element[0].textContent = String(d.month) + '/' + String(d.day) + '(' + d.youbi + ')へ';

        // 対象日の設定
        setDayTitle();

        // 通信中以外のダイアログは表示されないようにする。
        dialogOff('inputNaiyou');
        dialogOff('tuushinError');
        dialogOff('kakunin');

        // ボタンクリックのハンドラ登録
        registerClick();

        // 通信中のダイアログ表示中なので、それ以外は操作を受け付けない
        setModal(true);

        stateMachine.dispatchInnerEvent(enumEvent.loadDone);
      }

/* 描画系 *******************************************************/

      function dialogOff(target) {
        let element = document.getElementsByClassName(target);
          element[0].style.display ="none";
      }

      function dialogOn(target) {
        let element = document.getElementsByClassName(target);
          element[0].style.display ="block";
      }

      function setDayTitle() {
        let element, 
          d = targetDate.get();

        element = document.getElementsByClassName('targetDay');
        element[0].textContent = String(d.month) + '/' + String(d.day) + '(' + d.youbi + ')の予定';
      }

      function setNaiyou() {
        let i, element, dataFilterd,
          d = targetDate.get(),
          syuu = calendar.getSyuu(d.year, d.month, d.day),
          datas = jikanwaritargetDate.get(),
          komaSelectf = function (koma) {
            return function (target) {
              if ( target[1] == koma ) {
                return true;
              }
            }
          };

          function _setKoma(koma) {
            let i;

            if (datas != null) {
              dataFilterd = datas.filter(komaSelectf(koma));
              for (i = 0; i < dataFilterd.length; i++) {
                if (dataFilterd[i][2] != '') {
                  return dataFilterd[i][2];
                }
              }
            }
            return calendar.getDefaultKamoku(syuu, d.youbi, koma);
          }

          function _setNaiyou(koma) {
            let i;

            if (datas != null) {
              dataFilterd = datas.filter(komaSelectf(koma));
              for (i = 0; i < dataFilterd.length; i++) {
                if (dataFilterd[i][3] != '') {
                  return dataFilterd[i][3];
                }
              }
            }
            return '';
          }
          function _setMotimono(koma) {
            let i;

            if (datas != null) {
              dataFilterd = datas.filter(komaSelectf(koma));
              for (i = 0; i < dataFilterd.length; i++) {
                if (dataFilterd[i][4] != '') {
                  return dataFilterd[i][4];
                }
              }
            }
            return '';
          }

        for (i = 0; i < 21; i= i+3) { // 7限×(科目と内容と持ち物の3個)=21
          let koma = Math.floor(i / 3) + 1;

          element = document.getElementsByClassName(tableClsName[i]);
          element[0].textContent = _setKoma(koma);
          element = document.getElementsByClassName(tableClsName[i+1]);
          element[0].textContent = _setNaiyou(koma);
          element = document.getElementsByClassName(tableClsName[i+2]);
          element[0].textContent = _setMotimono(koma);
        }
      }

      function setInputNaiyou(koma) {
        let element, str,
          d = targetDate.get();

        // 表示されるようにする
        element = document.getElementsByClassName('inputNaiyou');
        element[0].style.display ="block";

        element = document.getElementsByClassName('inputTitle');
        element[0].textContent = String(d.month) + '/' + String(d.day) + '(' + d.youbi + ')' + koma + '時間目の予定を編集する';

        element = document.getElementsByClassName('kamoku' + '-' + koma);
        str = element[0].textContent;
        element = document.getElementsByClassName('kamokuBox');
        element[0].value = str;

        element = document.getElementsByClassName('naiyou' + '-' + koma);
        str = element[0].textContent;
        element = document.getElementsByClassName('naiyouBox');
        element[0].value = str;

        element = document.getElementsByClassName('motimo' + '-' + koma);
        str = element[0].textContent;
        element = document.getElementsByClassName('motimonoBox');
        element[0].value = str;
      }

/* 通信系 *******************************************************/

      function setDayAndGetNaiyou (arg) {
        let d;

        switch (arg) {
          case 'previousDay':
            targetDate.previous();
            break;

          case 'today':
            targetDate.reset();
            break;

          case 'NextDay':
            targetDate.next();;
            break;

          default: // 特に日時を変更しない。
            break;
        }

        d = targetDate.get();
        getNaiyou(d.year, d.month, d.day);
      }

      function getNaiyou (year, month, day) {
        google.script.run.withSuccessHandler(function(arg){
          // 成功時の処理
          jikanwaritargetDate.set(arg.res);
          if (logout) {
            console.log("getNaiyou success");
            console.log(arg.res);
          }
          stateMachine.dispatchInnerEvent(enumEvent.sendReceiveDone);

        }).withFailureHandler(function(arg){
          // 失敗時の処理
          if (logout) {console.log("getNaiyou failure")};

          stateMachine.dispatchInnerEvent(enumEvent.sendReceiveError);

        }).getNaiyouFromDB(year, month, day);
      }

      function putNaiyou () {
        let kamoku, naiyou, motimono;

        element = document.getElementsByClassName('kamokuBox');
        kamoku = element[0].value;
        element = document.getElementsByClassName('naiyouBox');
        naiyou = element[0].value;
        element = document.getElementsByClassName('motimonoBox');
        motimono = element[0].value;

        putNaiyouInner(kamoku, naiyou, motimono);
      }

      function putNaiyouSakujyo () {
        let kamoku = '　',
          naiyou   = '　',
          motimono = '　';

        // 実際は消さない。空白を入れて、見えなくするだけ。
        putNaiyouInner(kamoku, naiyou, motimono);
      }

      function putNaiyouInner (kamoku, naiyou, motimono) {
        let d = targetDate.get(),
          koma = targetDate.getKoma();

        google.script.run.withSuccessHandler(function(arg){
          // 成功時の処理
          stateMachine.dispatchInnerEvent(enumEvent.sendReceiveDone);

        }).withFailureHandler(function(arg){
          // 失敗時の処理
          stateMachine.dispatchInnerEvent(enumEvent.sendReceiveError);

        }).putNaiyouToDB(d.year, d.month, d.day, koma, kamoku, naiyou, motimono);
      }

/* イベントハンドラ系 *******************************************************/

      function onPreviousDayClick() {
        stateMachine.dispatchInnerEvent(enumEvent.userPrevDay);
      }

      function onNextDayClick() {
        stateMachine.dispatchInnerEvent(enumEvent.userNextDay);
      }

      function onTodayClick() {
        stateMachine.dispatchInnerEvent(enumEvent.userToday);
      }

      function onCloserClick() {
        stateMachine.dispatchInnerEvent(enumEvent.userCancel);
      }

      function ontuushinErrorOK() {
          stateMachine.dispatchInnerEvent(enumEvent.userOK);
      }

      function tableClickHandler() {
        let clsName = this.getAttribute('class'),
          clicked = clsName.split('-'), // clicked[0] で'kamoku' or 'naiyou' or 'motimo', clicked[1]で〇時間目がとれる
          koma = clicked[1];

          stateMachine.dispatchInnerEvent(enumEvent.userInputNaiyou, koma);
      }

      function onNaiyouTouroku() {
        stateMachine.dispatchInnerEvent(enumEvent.userRegister);
      }

      function onNaiyouSakujyo() {
        stateMachine.dispatchInnerEvent(enumEvent.userDelete);
      }

      function onKakuninOK() {
        stateMachine.dispatchInnerEvent(enumEvent.userOK);
      }

      function onKakuninCancel() {
        stateMachine.dispatchInnerEvent(enumEvent.userCancel);
      }

      function setModal(flg) {
        let element, setModalconfig;

        if ( flg == true ) {
          setModalconfig = 'none';
        } else {
          setModalconfig = 'auto';
        }

        element = document.getElementsByClassName('toPreviousDay');
        element[0].style.pointerEvents = setModalconfig;
        element = document.getElementsByClassName('toToday');
        element[0].style.pointerEvents = setModalconfig;
        element = document.getElementsByClassName('toNextDay');
        element[0].style.pointerEvents = setModalconfig;
        element = document.getElementsByClassName('jikanwari-main');
        element[0].style.pointerEvents = setModalconfig;
      }

/* イベントハンドラ登録系 *******************************************************/

      function registerClick() {
        let i, element;

        for (i = 0; i < tableClsName.length; i++) {
          element = document.getElementsByClassName(tableClsName[i]);
          element[0].addEventListener('click', tableClickHandler);
        }

        element = document.getElementsByClassName('toPreviousDay');
        element[0].addEventListener('click', onPreviousDayClick);

        element = document.getElementsByClassName('toNextDay');
        element[0].addEventListener('click', onNextDayClick);

        element = document.getElementsByClassName('toToday');
        element[0].addEventListener('click', onTodayClick);

        element = document.getElementsByClassName('closer');
        element[0].addEventListener('click', onCloserClick);

        element = document.getElementsByClassName('naiyouTouroku');
        element[0].addEventListener('click', onNaiyouTouroku);

        element = document.getElementsByClassName('naiyouSakujyo');
        element[0].addEventListener('click', onNaiyouSakujyo);

        element = document.getElementsByClassName('tuushinErrorOK');
        element[0].addEventListener('click', ontuushinErrorOK);

        element = document.getElementsByClassName('kakuninOK');
        element[0].addEventListener('click', onKakuninOK);

        element = document.getElementsByClassName('kakuninCancel');
        element[0].addEventListener('click', onKakuninCancel);
      }

    </script>
  </body>
</html>